<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Getting Peaks of `.dscalar` file | Stephen Mazurchuk</title> <meta name="author" content="Stephen Mazurchuk"> <meta name="description" content="It is always difficult for me to get peaks"> <meta name="keywords" content="mazurchuk, fmri, language, machine learning, academic-website, portfolio-website"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.png"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://smazurchuk.com/blog/2023/dscalar/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> <style type="text/css">.fake-img{background:#bbb;border:1px solid rgba(0,0,0,0.1);box-shadow:0 0 4px rgba(0,0,0,0.1);margin-bottom:12px}.fake-img p{font-family:monospace;color:white;text-align:left;margin:12px 0;text-align:center;font-size:16px}</style> </head> <body> <d-front-matter> <script async type="text/json">{
      "title": "Getting Peaks of `.dscalar` file",
      "description": "It is always difficult for me to get peaks",
      "published": "September 1, 2023",
      "authors": [
        {
          "author": "Stephen Mazurchuk",
          "authorURL": "https://en.wikipedia.org/wiki/Albert_Einstein",
          "affiliations": [
            {
              "name": "MCW, Milwaukee",
              "url": ""
            }
          ]
        }
        
      ],
      "katex": {
        "delimiters": [
          {
            "left": "$",
            "right": "$",
            "display": false
          },
          {
            "left": "$$",
            "right": "$$",
            "display": true
          }
        ]
      }
    }</script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Stephen </span>Mazurchuk</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications and Abstracts</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">Repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>Getting Peaks of `.dscalar` file</h1> <p>It is always difficult for me to get peaks</p> </d-title> <d-byline></d-byline> <d-article> <h2 id="background">Background</h2> <p>I’m always struggling to work with headers. Here is some code.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">nibabel</span> <span class="k">as</span> <span class="n">nib</span>
<span class="kn">import</span> <span class="n">subprocess</span> <span class="k">as</span> <span class="n">sp</span>

<span class="c1"># Load files paths
</span><span class="n">results</span> <span class="o">=</span> <span class="sh">'</span><span class="s">univariateContrasts.dscalar.nii`
ls      = </span><span class="sh">'</span><span class="n">tpl</span><span class="o">-</span><span class="n">fsLR</span><span class="o">/</span><span class="n">tpl</span><span class="o">-</span><span class="n">fsLR_den</span><span class="o">-</span><span class="mi">32</span><span class="n">k_hemi</span><span class="o">-</span><span class="n">L_midthickness</span><span class="p">.</span><span class="n">surf</span><span class="p">.</span><span class="n">gii</span><span class="sh">'</span><span class="s"> # Left surface
rs      = </span><span class="sh">'</span><span class="n">tpl</span><span class="o">-</span><span class="n">fsLR</span><span class="o">/</span><span class="n">tpl</span><span class="o">-</span><span class="n">fsLR_den</span><span class="o">-</span><span class="mi">32</span><span class="n">k_hemi</span><span class="o">-</span><span class="n">R_midthickness</span><span class="p">.</span><span class="n">surf</span><span class="p">.</span><span class="n">gii</span><span class="sh">'</span><span class="s"> # Right surface
# Only take clusters larger than 20mm^2
cmd1 = f</span><span class="sh">"</span><span class="s">wb_command -cifti-find-clusters univariateContrasts_conj_p01.dscalar.nii 0 20 0 20 COLUMN clusterized.dscalar.nii -left-surface {ls} -right-surface {rs}</span><span class="sh">"</span><span class="s">
# Collapse maps to one map
cmd2 = f</span><span class="sh">"</span><span class="s">wb_command -cifti-reduce clusterized.dscalar.nii MAX clusterized.dscalar.nii</span><span class="sh">"</span><span class="s">
# Multiply results by cluster mask
cmd3 = f</span><span class="sh">"</span><span class="s">wb_command -cifti-math </span><span class="sh">'</span><span class="n">x</span> <span class="o">*</span><span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="sh">'</span><span class="s"> maskedVals.dscalar.nii -var x univariateContrasts_conj_p01.dscalar.nii -var mask clusterized.dscalar.nii</span><span class="sh">"</span><span class="s">
# Get the extrema that are at least 5mm apart
cmd4 = f</span><span class="sh">"</span><span class="s">wb_command -cifti-extrema  maskedVals.dscalar.nii 5 5 COLUMN peaks.dscalar.nii -left-surface {ls} -right-surface {rs} -only-maxima</span><span class="sh">"</span><span class="s">
# Dilate extrema for easier visualization
cmd5 = f</span><span class="sh">"</span><span class="s">wb_command -cifti-dilate peaks.dscalar.nii COLUMN 2 2 dPeaks.dscalar.nii -left-surface {ls} -right-surface {rs}</span><span class="sh">"</span><span class="s">
sp.run(cmd1,shell=True)
sp.run(cmd2,shell=True)
sp.run(cmd3,shell=True)
sp.run(cmd4,shell=True)
sp.run(cmd5,shell=True)



# Load surface files (.gii)

</span></code></pre></div></div> <p>A while go I had a project where I had to calculate intraclass correlation coefficents. As it turns out, theere isn’t much python code to do so! The main library you will find online implements it, but it is quite slow. Here I will use it the reference implementation.</p> <p>The context where I use it is to calculate the correlation between multiple RDMs. The following python code demonstrates</p> <p>While this code is not for motivating the use of RSA, we can tackle multiple birds with one stone!</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">pingouin</span> <span class="k">as</span> <span class="n">pg</span>

<span class="c1"># Make data
</span><span class="n">numSubjs</span>  <span class="o">=</span> <span class="mi">40</span>
<span class="n">numObs</span>    <span class="o">=</span> <span class="mi">10000</span>   
<span class="n">true_signal</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="n">numObs</span><span class="p">)</span>
<span class="n">observations</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">true_signal</span> <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randn</span><span class="p">(</span><span class="n">numObs</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">numSubjs</span><span class="p">)])</span>

<span class="c1"># Calculate ICC using Pingoin
</span><span class="n">df</span>         <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">subj</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">index</span>
<span class="n">tallDF</span>     <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">melt</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">id_vars</span><span class="o">=</span><span class="sh">'</span><span class="s">subj</span><span class="sh">'</span><span class="p">)</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> 
<span class="n">res</span> <span class="o">=</span> <span class="n">pg</span><span class="p">.</span><span class="nf">intraclass_corr</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">tallDF</span><span class="p">,</span>
                         <span class="n">targets</span> <span class="o">=</span> <span class="sh">'</span><span class="s">variable</span><span class="sh">'</span><span class="p">,</span>
                         <span class="n">raters</span>  <span class="o">=</span> <span class="sh">'</span><span class="s">subj</span><span class="sh">'</span><span class="p">,</span>
                         <span class="n">ratings</span> <span class="o">=</span> <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">%.2f seconds</span><span class="sh">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
</code></pre></div></div> <p>Execution takes <strong>96.60 seconds</strong>!!</p> <p>This amount of time makes it prohibitive to use this in a searchlight procedure! Let’s write our own function. My main reference for writing the function is to take it directly from here.</p> <p>Just writing out the code with no optimizations gives the following code</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">icc3</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Each row is a target, and each column is a rater/subject
    </span><span class="sh">"""</span>
    <span class="n">x</span>  <span class="o">=</span> <span class="n">sample</span>  
    <span class="n">n</span>  <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">k</span>  <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">S</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">k</span> <span class="c1"># Mean across rows
</span>    <span class="n">M</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span> <span class="c1"># Mean down columns
</span>    <span class="n">xb</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="c1"># Start big loop
</span>    <span class="n">SST</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">SSBS</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">SSBM</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">SSWS</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">SSWM</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">SST</span>  <span class="o">+=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">xb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">SSBS</span> <span class="o">+=</span> <span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">xb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">SSBM</span> <span class="o">+=</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">xb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">SSWS</span> <span class="o">+=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">SSWM</span> <span class="o">+=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">SSE</span>  <span class="o">=</span> <span class="n">SST</span> <span class="o">-</span> <span class="n">SSBS</span> <span class="o">-</span> <span class="n">SSBM</span>
    <span class="n">MSE</span>  <span class="o">=</span> <span class="n">SSE</span> <span class="o">/</span> <span class="p">((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">MSBS</span> <span class="o">=</span> <span class="n">SSBS</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># This is ICC(c,1)
</span>    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">MSBS</span> <span class="o">-</span> <span class="n">MSE</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">MSBS</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">MSE</span><span class="p">)</span>  
    
    <span class="k">return</span> <span class="n">p</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> 
<span class="n">result2</span> <span class="o">=</span> <span class="nf">icc3</span><span class="p">(</span><span class="n">observations</span><span class="p">.</span><span class="n">T</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">%.2f seconds</span><span class="sh">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

<span class="nf">print</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">.</span><span class="n">Type</span><span class="o">==</span><span class="sh">'</span><span class="s">ICC3</span><span class="sh">'</span><span class="p">].</span><span class="n">ICC</span><span class="p">.</span><span class="nf">item</span><span class="p">(),</span> <span class="sh">'</span><span class="s">   |    </span><span class="sh">'</span><span class="p">,</span><span class="n">result2</span><span class="p">)</span>
</code></pre></div></div> <pre><code class="language-pre">0.68 seconds
0.07847971556491169    |     0.07847971556491638
</code></pre> <p>One benefit (and indeed intention) of writing the funtion without only basic <code class="language-plaintext highlighter-rouge">numpy</code> calls without any arguments is so that it can be fed into <code class="language-plaintext highlighter-rouge">numba</code>!</p> <p>Simply adding the <code class="language-plaintext highlighter-rouge">@njit</code> decorator we get the following improvement!</p> <p>Original:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%timeit icc3<span class="o">(</span>observations.T<span class="o">)</span>
589 ms ± 9.23 ms per loop <span class="o">(</span>mean ± std. dev. of 7 runs, 1 loop each<span class="o">)</span>
</code></pre></div></div> <p>With numba:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%timeit icc3<span class="o">(</span>observations.T<span class="o">)</span>
1.37 ms ± 5.84 µs per loop <span class="o">(</span>mean ± std. dev. of 7 runs, 1,000 loops each<span class="o">)</span>
</code></pre></div></div> <p>That’s a pretty good improvement! We went from 96 seconds, to 1.3 mili-seconds</p> <h2 id="further-modification">Further modification</h2> <p>In some environments, <code class="language-plaintext highlighter-rouge">numba</code> might not be available. We can remove the loops and resort to just pure numpy functions.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">icc3</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Each row is a target, and each column is a rater/subject
    </span><span class="sh">"""</span>
    <span class="n">x</span>  <span class="o">=</span> <span class="n">sample</span>  
    <span class="n">n</span>  <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">k</span>  <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">S</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">k</span> <span class="c1"># Mean across rows
</span>    <span class="n">M</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span> <span class="c1"># Mean down columns
</span>    <span class="n">xb</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="c1"># Loop-free approach
</span>    <span class="n">SST</span>   <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">MSE</span>  <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="nf">var</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span> 
    <span class="n">MSBS</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="p">((</span><span class="n">S</span><span class="o">-</span><span class="n">xb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># This is ICC(c,1)
</span>    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">MSBS</span> <span class="o">-</span> <span class="n">MSE</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">MSBS</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">MSE</span><span class="p">)</span> 

    <span class="k">return</span> <span class="n">p</span>
</code></pre></div></div> <p>The timing for this function</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%timeit icc3<span class="o">(</span>observations.T<span class="o">)</span>
1.69 ms ± 12.7 µs per loop <span class="o">(</span>mean ± std. dev. of 7 runs, 1,000 loops each<span class="o">)</span>
</code></pre></div></div> <p>We find it is almost the same speed as the numba!</p> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/"></d-bibliography> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Stephen Mazurchuk. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Last updated: November 14, 2023. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>